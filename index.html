<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>Chamada de Vídeo - Bibi Muniz</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      /* Importando fonte estilo iOS */
      @import url("https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap");

      body {
        font-family: "Inter", -apple-system, BlinkMacSystemFont, sans-serif;
        background-color: #000;
        overflow: hidden; /* Previne scroll */
        touch-action: none; /* Previne gestos padrão do navegador */
      }

      /* Utilitários para altura real em mobile */
      .h-dvh {
        height: 100dvh;
      }

      /* Animação de vibração visual */
      @keyframes vibrate-animation {
        0% {
          transform: translate(0);
        }
        20% {
          transform: translate(-2px, 2px);
        }
        40% {
          transform: translate(-2px, -2px);
        }
        60% {
          transform: translate(2px, 2px);
        }
        80% {
          transform: translate(2px, -2px);
        }
        100% {
          transform: translate(0);
        }
      }

      .animate-shake {
        animation: vibrate-animation 0.5s linear infinite;
      }

      /* Animação de pulso para o botão de atender */
      @keyframes pulse-ring {
        0% {
          transform: scale(1);
          box-shadow: 0 0 0 0 rgba(74, 222, 128, 0.7);
        }
        70% {
          transform: scale(1.1);
          box-shadow: 0 0 0 20px rgba(74, 222, 128, 0);
        }
        100% {
          transform: scale(1);
          box-shadow: 0 0 0 0 rgba(74, 222, 128, 0);
        }
      }

      .pulse-btn {
        animation: pulse-ring 2s infinite;
      }

      /* Glassmorphism */
      .glass {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
      }

      /* Control Button Styles */
      .control-btn {
        transition: all 0.2s ease;
      }
      .control-btn.active {
        background-color: white;
        color: black;
      }
      .control-btn.inactive {
        background-color: rgba(255, 255, 255, 0.2);
        color: white;
      }

      /* Hide Scrollbar */
      ::-webkit-scrollbar {
        display: none;
      }
    </style>
  </head>
  <body class="bg-black text-white h-dvh w-full select-none">
    <!-- App Container -->
    <div
      id="app"
      class="relative h-full w-full flex flex-col items-center justify-center"
    >
      <!-- TELA 0: TOQUE PARA CONTINUAR (desbloqueia áudio/vibração) -->
      <div
        id="start-screen"
        class="absolute inset-0 bg-black flex flex-col items-center justify-center px-8 z-50"
      >
        <!-- Ícone de chamada -->
        <div
          class="w-20 h-20 rounded-full bg-green-500/20 flex items-center justify-center mb-6 animate-pulse"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-10 w-10 text-green-500"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
            stroke-width="2"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"
            />
          </svg>
        </div>

        <!-- Texto -->
        <h2 class="text-white text-xl font-semibold mb-2">Chamada de Vídeo</h2>
        <p class="text-gray-400 text-sm text-center mb-8">
          Você tem uma chamada de vídeo pendente
        </p>

        <!-- Botão -->
        <button
          onclick="startExperience()"
          class="px-8 py-4 bg-green-500 hover:bg-green-600 active:bg-green-700 rounded-full text-white font-semibold text-lg transition-all transform active:scale-95 shadow-lg"
        >
          Toque para ver
        </button>
      </div>

      <!-- TELA 1: CARREGAMENTO -->
      <div
        id="loading-screen"
        class="hidden flex flex-col items-center gap-4 transition-opacity duration-500"
      >
        <div
          class="w-8 h-8 border-4 border-gray-600 border-t-white rounded-full animate-spin"
        ></div>
        <p class="text-sm text-gray-400">Conectando...</p>
      </div>

      <!-- TELA 2: RECEBENDO CHAMADA -->
      <div
        id="incoming-screen"
        class="hidden absolute inset-0 bg-cover bg-center h-full w-full flex flex-col"
        style="
          background-image: url('https://images.unsplash.com/photo-1616004655123-8185ebd769da?q=80&w=1000&auto=format&fit=crop');
        "
      >
        <!-- Overlay Blur Escuro -->
        <div class="absolute inset-0 bg-gray-900/80 backdrop-blur-md z-0"></div>

        <div
          class="relative z-10 flex flex-col h-full w-full p-8 pt-24 justify-between"
        >
          <!-- Informações do Chamador -->
          <div class="flex flex-col items-center gap-2">
            <div
              class="w-32 h-32 rounded-full bg-gray-300 overflow-hidden shadow-2xl mb-4 border-2 border-white/20"
            >
              <!-- Foto de Perfil da Bibi -->
              <img
                src="bibi-profile.jpg"
                alt="Bibi Muniz"
                class="w-full h-full object-cover"
              />
            </div>
            <h1 class="text-3xl font-semibold tracking-tight">Bibi Muniz</h1>
            <p class="text-gray-300 text-lg flex items-center gap-2">
              <span
                class="w-2 h-2 bg-green-500 rounded-full animate-pulse"
              ></span>
              Chamada de vídeo...
            </p>
          </div>

          <!-- Botões de Ação -->
          <div class="w-full flex justify-between items-end pb-12 px-4">
            <!-- Recusar -->
            <div class="flex flex-col items-center gap-2">
              <button
                onclick="rejectCall()"
                class="w-16 h-16 rounded-full bg-red-500 flex items-center justify-center shadow-lg active:scale-95 transition-transform"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="h-8 w-8 text-white"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M6 18L18 6M6 6l12 12"
                  />
                </svg>
              </button>
              <span class="text-sm font-medium">Recusar</span>
            </div>

            <!-- Mensagem (Decorativo) -->
            <div class="flex flex-col items-center gap-2 mb-2">
              <div
                class="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="h-5 w-5"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"
                  />
                </svg>
              </div>
              <span class="text-xs text-white/70">Mensagem</span>
            </div>

            <!-- Aceitar -->
            <div class="flex flex-col items-center gap-2">
              <button
                onclick="acceptCall()"
                class="w-16 h-16 rounded-full bg-green-500 flex items-center justify-center shadow-lg pulse-btn active:scale-95 transition-transform"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="h-8 w-8 text-white"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"
                  />
                </svg>
              </button>
              <span class="text-sm font-medium">Aceitar</span>
            </div>
          </div>
        </div>
      </div>

      <!-- TELA 3: CHAMADA ATIVA -->
      <div
        id="active-call-screen"
        class="hidden absolute inset-0 bg-black h-full w-full flex flex-col justify-between"
      >
        <!-- Video Container -->
        <div class="flex-1 w-full bg-black relative overflow-hidden">
          <!-- Vídeo Principal (da pessoa chamando) -->
          <video
            id="remote-video"
            class="absolute inset-0 w-full h-full object-cover"
            playsinline
            loop
          >
            <source src="video.mp4" type="video/mp4" />
            Seu navegador não suporta vídeos.
          </video>

          <!-- Self View (Câmera do usuário - Miniatura) -->
          <!-- Self View (Câmera do usuário - Miniatura) - Escondido por padrão -->
          <div
            id="self-view-container"
            class="hidden absolute top-16 right-4 w-28 h-40 bg-gray-900 rounded-xl overflow-hidden border-2 border-white/30 shadow-2xl z-10"
          >
            <!-- Vídeo da câmera frontal do usuário -->
            <video
              id="local-video"
              class="w-full h-full object-cover"
              playsinline
              autoplay
              muted
            ></video>
            <!-- Loading enquanto solicita permissão da câmera -->
            <div
              id="camera-loading"
              class="absolute inset-0 w-full h-full bg-gray-800 flex flex-col items-center justify-center gap-2"
            >
              <div
                class="w-6 h-6 border-2 border-gray-600 border-t-white rounded-full animate-spin"
              ></div>
              <span class="text-[10px] text-gray-400">Câmera...</span>
            </div>
            <!-- Fallback quando câmera está desligada -->
            <div
              id="camera-off-placeholder"
              class="hidden absolute inset-0 w-full h-full bg-gray-800 flex items-center justify-center"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-8 w-8 text-gray-500"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"
                />
              </svg>
            </div>
            <!-- Quando permissão da câmera é negada -->
            <div
              id="camera-denied"
              class="hidden absolute inset-0 w-full h-full bg-gray-800 flex flex-col items-center justify-center gap-1 p-2"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-6 w-6 text-red-400"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"
                />
              </svg>
              <span class="text-[8px] text-gray-400 text-center"
                >Câmera bloqueada</span
              >
            </div>
          </div>

          <!-- Nome e Timer sobreposto ao vídeo -->
          <div class="absolute top-16 left-6 z-10">
            <h2
              class="text-white text-2xl font-bold tracking-tight drop-shadow-lg"
            >
              Bibi Muniz
            </h2>
            <p
              id="call-timer"
              class="text-white/80 font-medium text-lg mt-1 drop-shadow-md"
            >
              00:00
            </p>
          </div>
        </div>

        <!-- Controles Flutuantes (Estilo iOS) -->
        <div
          class="w-[95%] mx-auto mb-8 p-4 rounded-3xl bg-gray-900/90 backdrop-blur-lg flex flex-col gap-6 shadow-2xl z-20"
        >
          <!-- Botões de Controle Superiores -->
          <div class="flex justify-between items-center px-4">
            <!-- Mute -->
            <button
              id="btn-mute"
              onclick="toggleMute()"
              class="control-btn inactive w-14 h-14 rounded-full flex items-center justify-center"
            >
              <svg
                id="icon-mute-off"
                xmlns="http://www.w3.org/2000/svg"
                class="h-7 w-7"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"
                />
              </svg>
              <svg
                id="icon-mute-on"
                xmlns="http://www.w3.org/2000/svg"
                class="h-7 w-7 hidden"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"
                  stroke-miterlimit="10"
                />
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M17 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2"
                />
              </svg>
            </button>

            <!-- Video -->
            <button
              id="btn-camera"
              onclick="toggleCamera()"
              class="control-btn inactive w-14 h-14 rounded-full flex items-center justify-center"
            >
              <!-- Ícone câmera ligada -->
              <svg
                id="icon-cam-on"
                xmlns="http://www.w3.org/2000/svg"
                class="h-7 w-7 hidden"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"
                />
              </svg>
              <!-- Ícone câmera desligada (com risco vermelho) -->
              <svg
                id="icon-cam-off"
                xmlns="http://www.w3.org/2000/svg"
                class="h-7 w-7"
                fill="none"
                viewBox="0 0 24 24"
              >
                <!-- Câmera -->
                <path
                  stroke="currentColor"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"
                />
                <!-- Risco vermelho diagonal -->
                <line
                  x1="4"
                  y1="4"
                  x2="20"
                  y2="20"
                  stroke="#ef4444"
                  stroke-width="2.5"
                  stroke-linecap="round"
                />
              </svg>
            </button>

            <!-- Speaker -->
            <button
              id="btn-speaker"
              onclick="toggleSpeaker()"
              class="control-btn inactive w-14 h-14 rounded-full flex items-center justify-center"
            >
              <svg
                id="icon-spk-off"
                xmlns="http://www.w3.org/2000/svg"
                class="h-7 w-7"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"
                />
              </svg>
              <svg
                id="icon-spk-on"
                xmlns="http://www.w3.org/2000/svg"
                class="h-7 w-7 hidden"
                fill="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  d="M11,4.2L5.8,9H2v6h3.8L11,19.8V4.2z M16.5,12c0-1.8-1-3.3-2.5-4v8C15.5,15.3,16.5,13.8,16.5,12z M14,3.2v2c3.4,0.9,6,4,6,8s-2.6,7.1-6,8v2c4.6-1,8-5.1,8-10S18.6,4.2,14,3.2z"
                />
              </svg>
            </button>
          </div>

          <!-- Botão de Desligar (Largo) -->
          <button
            onclick="endCall()"
            class="w-full py-4 bg-red-500 rounded-2xl flex items-center justify-center active:bg-red-600 transition-colors"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-8 w-8 text-white"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M16 8l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2M5 3a2 2 0 00-2 2v1c0 8.284 6.716 15 15 15h1a2 2 0 002-2v-3.28a1 1 0 00-.684-.948l-4.493-1.498a1 1 0 00-1.21.502l-1.13 2.257a11.042 11.042 0 01-5.516-5.517l2.257-1.128a1 1 0 00.502-1.21L9.228 3.683A1 1 0 008.279 3H5z"
              />
            </svg>
          </button>
        </div>
      </div>

      <!-- TELA 4: AVALIAÇÃO DA CHAMADA (Estilo Instagram) -->
      <div
        id="ended-screen"
        class="hidden absolute inset-0 bg-black flex flex-col items-center justify-center px-8"
      >
        <!-- Foto de Perfil -->
        <div
          class="w-24 h-24 rounded-full overflow-hidden mb-4 shadow-lg border-2 border-white/20"
        >
          <img
            src="bibi-profile.jpg"
            alt="Bibi Muniz"
            class="w-full h-full object-cover"
          />
        </div>

        <!-- Nome -->
        <h2 class="text-white text-xl font-semibold mb-2">Bibi Muniz</h2>

        <!-- Duração da chamada -->
        <p id="call-duration" class="text-gray-400 text-sm mb-6">
          Chamada encerrada
        </p>

        <!-- Texto de avaliação -->
        <p class="text-gray-300 text-sm mb-4">
          Como foi a qualidade da chamada?
        </p>

        <!-- Estrelas de Avaliação -->
        <div id="rating-stars" class="flex gap-2 mb-8">
          <button
            onclick="rateCall(1)"
            class="star-btn text-4xl text-gray-600 hover:text-yellow-400 transition-colors"
            data-rating="1"
          >
            ★
          </button>
          <button
            onclick="rateCall(2)"
            class="star-btn text-4xl text-gray-600 hover:text-yellow-400 transition-colors"
            data-rating="2"
          >
            ★
          </button>
          <button
            onclick="rateCall(3)"
            class="star-btn text-4xl text-gray-600 hover:text-yellow-400 transition-colors"
            data-rating="3"
          >
            ★
          </button>
          <button
            onclick="rateCall(4)"
            class="star-btn text-4xl text-gray-600 hover:text-yellow-400 transition-colors"
            data-rating="4"
          >
            ★
          </button>
          <button
            onclick="rateCall(5)"
            class="star-btn text-4xl text-gray-600 hover:text-yellow-400 transition-colors"
            data-rating="5"
          >
            ★
          </button>
        </div>

        <!-- Mensagem de agradecimento (aparece após avaliar) -->
        <p id="thanks-message" class="hidden text-green-400 text-sm mb-4">
          Obrigado pela avaliação!
        </p>

        <!-- Botão de fechar -->
        <button
          onclick="closeRating()"
          class="text-gray-400 text-sm hover:text-white transition-colors"
        >
          Fechar
        </button>
      </div>

      <!-- TELA 5: CHAMADA BLOQUEADA / EXPIRADA -->
      <div
        id="blocked-screen"
        class="hidden absolute inset-0 bg-black flex flex-col items-center justify-center px-8"
      >
        <!-- Ícone X vermelho com círculo -->
        <div class="relative mb-8">
          <!-- Círculo externo com glow vermelho -->
          <div
            class="w-20 h-20 rounded-full bg-red-500/20 flex items-center justify-center"
          >
            <!-- Círculo interno -->
            <div
              class="w-14 h-14 rounded-full bg-red-500/30 flex items-center justify-center"
            >
              <!-- Ícone X -->
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-8 w-8 text-red-500"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
                stroke-width="2"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  d="M6 18L18 6M6 6l12 12"
                />
              </svg>
            </div>
          </div>
        </div>

        <!-- Título -->
        <h2 class="text-white text-2xl font-bold mb-3">Chamada Encerrada</h2>

        <!-- Subtítulo -->
        <p class="text-gray-400 text-sm text-center">
          O tempo para assistir esta chamada expirou.
        </p>
      </div>
    </div>

    <script>
      // --- VARIÁVEIS DE ESTADO ---
      let vibrationInterval;
      let callTimerInterval;
      let seconds = 0;
      let isMuted = false;
      let isCameraOn = false; // Câmera começa desligada
      let isSpeakerOn = false;
      let localStream = null; // Stream da câmera do usuário
      let ringtoneAudio = null; // Áudio do toque de chamada

      // Chave para localStorage
      const STORAGE_KEY = "video_call_used";

      // --- FLUXO PRINCIPAL ---

      // 1. Ao carregar a página
      window.onload = () => {
        // Verifica se o usuário já usou o acesso
        if (localStorage.getItem(STORAGE_KEY) === "true") {
          // Usuário já acessou antes - mostra tela de bloqueio
          document.getElementById("start-screen").classList.add("hidden");
          document.getElementById("blocked-screen").classList.remove("hidden");
          return; // Não continua o fluxo normal
        }

        // Pré-carrega o áudio do toque de chamada
        ringtoneAudio = new Audio(
          "https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"
        );
        ringtoneAudio.loop = true;
        ringtoneAudio.volume = 0.7;

        // Mostra a tela de "Toque para ver" (já está visível por padrão)
      };

      // 2. Função chamada quando o usuário toca no botão
      function startExperience() {
        // Esconde a tela inicial
        document.getElementById("start-screen").classList.add("hidden");

        // Mostra o carregamento
        document.getElementById("loading-screen").classList.remove("hidden");

        // Após 2.5 segundos, mostra a chamada recebida
        setTimeout(() => {
          // Esconde carregamento, Mostra chamada recebida
          document.getElementById("loading-screen").classList.add("hidden");
          document.getElementById("incoming-screen").classList.remove("hidden");

          // Agora o áudio e vibração funcionarão porque houve interação do usuário!
          startVibration();
          startRingtone();
        }, 2500);
      }

      // --- FUNÇÕES DA CÂMERA DO USUÁRIO ---

      let cameraPermissionDenied = false; // Rastreia se a permissão foi negada

      function hideAllCameraStates() {
        document.getElementById("local-video").classList.add("hidden");
        document.getElementById("camera-loading").classList.add("hidden");
        document
          .getElementById("camera-off-placeholder")
          .classList.add("hidden");
        document.getElementById("camera-denied").classList.add("hidden");
      }

      async function startUserCamera() {
        // Se a permissão já foi negada, não tenta novamente
        if (cameraPermissionDenied) {
          hideAllCameraStates();
          document.getElementById("camera-denied").classList.remove("hidden");
          isCameraOn = false;
          updateCameraButtonState();
          return;
        }

        // Mostra o container da câmera e loading enquanto solicita permissão
        document
          .getElementById("self-view-container")
          .classList.remove("hidden");
        hideAllCameraStates();
        document.getElementById("camera-loading").classList.remove("hidden");

        try {
          // Solicita acesso à câmera frontal
          localStream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: "user" }, // Câmera frontal
            audio: false, // Não precisamos de áudio para visualização
          });

          const localVideo = document.getElementById("local-video");
          localVideo.srcObject = localStream;

          // Esconde loading e mostra vídeo
          hideAllCameraStates();
          localVideo.classList.remove("hidden");

          isCameraOn = true;
          updateCameraButtonState();
        } catch (error) {
          console.error("Erro ao acessar câmera:", error);
          hideAllCameraStates();

          // Verifica se foi permissão negada
          if (
            error.name === "NotAllowedError" ||
            error.name === "PermissionDeniedError"
          ) {
            cameraPermissionDenied = true;
            document.getElementById("camera-denied").classList.remove("hidden");
          } else {
            // Outro erro (dispositivo sem câmera, etc)
            document
              .getElementById("camera-off-placeholder")
              .classList.remove("hidden");
          }

          isCameraOn = false;
          updateCameraButtonState();
        }
      }

      function stopUserCamera() {
        if (localStream) {
          localStream.getTracks().forEach((track) => track.stop());
          localStream = null;
        }
        const localVideo = document.getElementById("local-video");
        localVideo.srcObject = null;

        // Esconde o container da câmera completamente
        document.getElementById("self-view-container").classList.add("hidden");
        hideAllCameraStates();
      }

      function showCameraOffPlaceholder() {
        hideAllCameraStates();
        document
          .getElementById("camera-off-placeholder")
          .classList.remove("hidden");
      }

      function updateCameraButtonState() {
        const btn = document.getElementById("btn-camera");
        if (isCameraOn) {
          btn.classList.add("active");
          btn.classList.remove("inactive");
          document.getElementById("icon-cam-on").classList.remove("hidden");
          document.getElementById("icon-cam-off").classList.add("hidden");
        } else {
          btn.classList.remove("active");
          btn.classList.add("inactive");
          document.getElementById("icon-cam-on").classList.add("hidden");
          document.getElementById("icon-cam-off").classList.remove("hidden");
        }
      }

      // --- FUNÇÕES DA CHAMADA ---

      function startVibration() {
        // Vibração contínua estilo chamada de celular
        // Padrão: vibra 800ms, pausa 400ms, vibra 800ms, pausa 1500ms (repete)
        if ("vibrate" in navigator) {
          // Inicia vibração imediatamente
          navigator.vibrate([800, 400, 800, 1500]);

          // Repete o padrão continuamente
          vibrationInterval = setInterval(() => {
            navigator.vibrate([800, 400, 800, 1500]);
          }, 3500); // Total do padrão: 800+400+800+1500 = 3500ms
        }
      }

      function stopVibration() {
        if ("vibrate" in navigator) {
          clearInterval(vibrationInterval);
          navigator.vibrate(0); // Para a vibração
        }
      }

      function startRingtone() {
        if (ringtoneAudio) {
          // Tenta reproduzir o áudio
          const playPromise = ringtoneAudio.play();

          if (playPromise !== undefined) {
            playPromise.catch((e) => {
              console.log("Áudio bloqueado pelo navegador:", e);
              // Se o áudio for bloqueado, tenta novamente após interação
            });
          }
        }
      }

      function stopRingtone() {
        if (ringtoneAudio) {
          ringtoneAudio.pause();
          ringtoneAudio.currentTime = 0;
        }
      }

      async function acceptCall() {
        // Marca que o usuário já usou o acesso
        localStorage.setItem(STORAGE_KEY, "true");

        stopVibration();
        stopRingtone();
        document.getElementById("incoming-screen").classList.add("hidden");
        document
          .getElementById("active-call-screen")
          .classList.remove("hidden");

        // Inicia o vídeo principal (da pessoa chamando)
        const remoteVideo = document.getElementById("remote-video");
        remoteVideo
          .play()
          .catch((e) => console.log("Erro ao reproduzir vídeo:", e));

        // Câmera do usuário NÃO inicia automaticamente
        // O usuário precisa clicar no botão de câmera para ativar
        updateCameraButtonState();

        startCallTimer();
      }

      function rejectCall() {
        // Marca que o usuário já usou o acesso
        localStorage.setItem(STORAGE_KEY, "true");

        stopVibration();
        stopRingtone();
        document.getElementById("incoming-screen").classList.add("hidden");
        document.getElementById("ended-screen").classList.remove("hidden");
        // Não recarrega - usuário só tem 1 acesso
      }

      function endCall() {
        stopTimer();
        stopUserCamera(); // Para a câmera do usuário

        // Para o vídeo principal
        const remoteVideo = document.getElementById("remote-video");
        remoteVideo.pause();
        remoteVideo.currentTime = 0;

        // Mostra a duração da chamada na tela de avaliação
        const mins = Math.floor(seconds / 60);
        const secs = seconds % 60;
        const duration = `${String(mins).padStart(2, "0")}:${String(
          secs
        ).padStart(2, "0")}`;
        document.getElementById(
          "call-duration"
        ).textContent = `Duração: ${duration}`;

        document.getElementById("active-call-screen").classList.add("hidden");
        document.getElementById("ended-screen").classList.remove("hidden");
        // Não recarrega automaticamente - espera a avaliação
      }

      // --- TIMER DA CHAMADA ---
      function startCallTimer() {
        const timerElement = document.getElementById("call-timer");
        callTimerInterval = setInterval(() => {
          seconds++;
          const mins = Math.floor(seconds / 60);
          const secs = seconds % 60;
          timerElement.textContent = `${String(mins).padStart(2, "0")}:${String(
            secs
          ).padStart(2, "0")}`;
        }, 1000);
      }

      function stopTimer() {
        clearInterval(callTimerInterval);
      }

      // --- BOTÕES DE CONTROLE (ACTIVE CALL) ---

      function toggleMute() {
        isMuted = !isMuted;
        const btn = document.getElementById("btn-mute");
        // Toggle visual classes
        if (isMuted) {
          btn.classList.remove("inactive");
          btn.classList.add("active"); // Fica branco quando mutado
          document.getElementById("icon-mute-off").classList.add("hidden");
          document.getElementById("icon-mute-on").classList.remove("hidden");
        } else {
          btn.classList.add("inactive");
          btn.classList.remove("active");
          document.getElementById("icon-mute-off").classList.remove("hidden");
          document.getElementById("icon-mute-on").classList.add("hidden");
        }
      }

      async function toggleCamera() {
        if (isCameraOn) {
          // Desliga a câmera
          stopUserCamera();
          isCameraOn = false;
        } else {
          // Liga a câmera
          await startUserCamera();
        }
        updateCameraButtonState();
      }

      function toggleSpeaker() {
        isSpeakerOn = !isSpeakerOn;
        const btn = document.getElementById("btn-speaker");
        if (isSpeakerOn) {
          btn.classList.add("active");
          btn.classList.remove("inactive");
          document.getElementById("icon-spk-off").classList.add("hidden");
          document.getElementById("icon-spk-on").classList.remove("hidden");
        } else {
          btn.classList.remove("active");
          btn.classList.add("inactive");
          document.getElementById("icon-spk-off").classList.remove("hidden");
          document.getElementById("icon-spk-on").classList.add("hidden");
        }
      }

      // --- SISTEMA DE AVALIAÇÃO ---

      function rateCall(rating) {
        const stars = document.querySelectorAll(".star-btn");

        // Pinta as estrelas até a selecionada
        stars.forEach((star, index) => {
          if (index < rating) {
            star.classList.remove("text-gray-600");
            star.classList.add("text-yellow-400");
          } else {
            star.classList.remove("text-yellow-400");
            star.classList.add("text-gray-600");
          }
        });

        // Mostra mensagem de agradecimento
        document.getElementById("thanks-message").classList.remove("hidden");

        // Esconde as estrelas e botão fechar
        document.getElementById("rating-stars").classList.add("hidden");
        document
          .querySelector("button[onclick='closeRating()']")
          .classList.add("hidden");
        document.querySelector(".text-gray-300").classList.add("hidden"); // Esconde a pergunta

        // Após 1.5 segundos, mostra a tela de bloqueio
        setTimeout(() => {
          showBlockedScreen();
        }, 1500);
      }

      function closeRating() {
        // Mostra a tela de bloqueio diretamente
        showBlockedScreen();
      }

      function showBlockedScreen() {
        // Esconde a tela de avaliação e mostra a tela de bloqueio
        document.getElementById("ended-screen").classList.add("hidden");
        document.getElementById("blocked-screen").classList.remove("hidden");
      }
    </script>
  </body>
</html>
